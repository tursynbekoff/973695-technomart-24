!function(e){function t(t){for(var o,r,l=t[0],n=t[1],d=t[2],_=0,c=[];_<l.length;_++)r=l[_],a[r]&&c.push(a[r][0]),a[r]=0;for(o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);for(u&&u(t);c.length;)c.shift()();return s.push.apply(s,d||[]),i()}function i(){for(var e,t=0;t<s.length;t++){for(var i=s[t],o=!0,l=1;l<i.length;l++){var n=i[l];0!==a[n]&&(o=!1)}o&&(s.splice(t--,1),e=r(r.s=i[0]))}return e}var o={},a={"web/audio":0},s=[];function r(t){if(o[t])return o[t].exports;var i=o[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=o,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(i,o,function(t){return e[t]}.bind(null,o));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="";var l=window.webpackJsonp=window.webpackJsonp||[],n=l.push.bind(l);l.push=t,l=l.slice();for(var d=0;d<l.length;d++)t(l[d]);var u=n;s.push([56,"common"]),i()}({56:function(e,t,i){e.exports=i("KEyx")},KEyx:function(__webpack_module__,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _lib_stats__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("XzvV"),SLIDER_TIMEOUT=1e4;function currentAudioPage(e){var t=gpeByClass("_audio_page_layout",e);return!!t&&data(t,"audioPage")}function AudioPage(e,t){data(e,"audioPage",this),extend(cur.lang||{},t.langs),getAudioPlayer().langs=t.langs,this._data=t,this._ownerId=t.ownerId,this.isLayer()||(cur.audioPage=this),this.isLayer()&&uiSearch.init("audio_search_layer"),AudioUtils.toggleAudioHQBodyClass(),this._els={pageContainer:e,sections:geByClass1("_audio_page_sections",e),playerWrap:geByClass1("_audio_page_player_wrap",e),player:geByClass1("_audio_page_player",e),contentBlock:geByClass1("_audio_page_content_block",e),scrollWrap:geByClass1("_audio_page_content_block_wrap",e),searchSectionAudios:geByClass1("_audio_section_search__local_audios_list",e),searchSectionAudiosHeader:geByClass1("audio_section_search__local_audios_header",e),searchSectionPlaylists:geByClass1("_audio_section_search__local_playlists_list",e),searchSectionPlaylistsHeader:geByClass1("_audio_section_search__local_playlists_header",e),searchNoLocalResults:geByClass1("_audio_local_no_results",e),searchGlobalBlocks:geByClass1("_audio_section_global_search__blocks",e),searchGlobalCommunitiesPlace:geByClass1("_audio_section_global_search__communities_place",e),searchGlobalPlaylistsPlace:geByClass1("_audio_section_global_search__playlists_place",e),searchGlobalArtistsPlace:geByClass1("_audio_section_global_search__artists_place",e),searchGlobalAudiosBlock:geByClass1("_audio_section_global_search__audios_block",e),searchGlobalAudiosBlockHeader:geByClass1("_audio_section_global_search__audios_header",e),searchGlobalAudiosList:geByClass1("_audio_section_global_search__audios_list",e),recomsBlocks:geByClass1("_audio_recoms_blocks",e),searchBlocks:geByClass1("_audio_search_blocks",e),searchInput:geByClass1("ui_search_field",geByClass1("_audio_search",e)),footer:geByClass1("_audio_page__footer",e),footerNowPlayingInfo:geByClass1("_audio_page__footer_now_playing",e),footerClearNowPlayingButton:geByClass1("_audio_page__footer_clear_playlist",e)},this.isLayer()&&(this._scroll=new uiScroll(this._els.scrollWrap,{global:!0,stopScrollPropagation:!0,stopScrollPropagationAlways:!0})),this._readyAudio=this._data.readyAudio;var i=this._data.readyPlaylist;i&&(this._pagePlaylist=getAudioPlayer().getPlaylist(i.type,i.ownerId,i.id),this._pagePlaylist.mergeWith(i)),!this._readyAudio&&this._pagePlaylist&&(this._readyAudio=this._pagePlaylist.getAudioAt(0)),this._data.playlistCoverUploadOptions&&(cur.audioCoverUploadOptions=cur.audioCoverUploadOptions||{},cur.audioCoverUploadOptions[this._ownerId]=this._data.playlistCoverUploadOptions),this.isLayer()||(cur.module=t.module||"audio",cur.oid=this._ownerId,this._ownerId==vk.id?cur.submodule="my":this._ownerId<0?cur.submodule="group_list":cur.submodule="user_list"),this._initPlayer(),this._initPlaylists(),this.initNavigation(),this.showPromoBox(),this.showSection(t.initSection),this._initSearchParams(),this.promoAlbumSlideInit(),this._els.searchInput&&this._els.searchInput.focus(),this.isLayer()||this.isPodcastPage()||!nav.objLoc.q||"search_playlists"===nav.objLoc.section||(this._els.searchInput&&(this._els.searchInput.value=nav.objLoc.q),this._showSearchSection(nav.objLoc)),this.updateCurrentPlayingInfo(),getAudioPlayer().setStatusExportInfo(this._data.export),this.updateStatusExportControls(),this._initKeyEvents(),window.onAudioPageLoaded&&(window.onAudioPageLoaded.call(this),delete window.onAudioPageLoaded),this.updateShuffleButton()}AudioPage.address="audio",AudioPage.updateSearchHighlight=function(e){var t=geByClass1("_audio_playlist",gpeByClass("_audio_layout",this));toggleClass(t,"audio_search_focused","focus"==e.type)},AudioPage.onSearchFocused=function(e){AudioPage.updateSearchHighlight(e)},AudioPage.onSearchBlurred=function(e){},AudioPage.prototype.updatePlaylistsCounter=function(e){if(cur.audioPage&&e===cur.audioPage.getOwnerId()){var t=geByClass1("_audio_page__playlists_count_header",cur.audioPage._els.pageContainer);if(t){var i=cur.audioPage._data.playlists.length;t.innerHTML=langNumeric(i,cur.lang.audio_playlists_count_title),toggleClass(gpeByClass("_audio_page_section_layout",t),"audio_section_empty",!i)}}},AudioPage.deletePlaylist=function(e,t,i){var o=getAudioPlayer().getPlaylist(AudioPlaylist.TYPE_PLAYLIST,e,t),a=AudioPlayer.getLang("audio_sure_delete_playlist_box_text");a='<div style="overflow: hidden; text-overflow: ellipsis;">'+(a=a.replace("{name}",o.getTitle()))+"</div>",showFastBox({title:AudioPlayer.getLang("audio_sure_delete_playlist_box_title"),dark:1},a,AudioPlayer.getLang("audio_sure_delete_playlist_box_yes"),function(){ajax.post("al_audio.php",{act:"delete_playlist",hash:i,playlist_owner_id:e,playlist_id:t,page_owner_id:cur.audioPage?cur.audioPage.getOwnerId():0},{onDone:function(e){if(cur.audioPage){var t=geByClass1("_audio_section__all",cur.audioPage.getPageContainer()),i=geByClass1("_audio_page_block__playlists_items",t);if(t&&i){var o=intval(domData(i,"max-items"));e&&i.children.length<o&&i.appendChild(se(getTemplate("audio_pl_item",e))),0==i.children.length&&(addClass(gpeByClass("_audio_page_section_layout",i),"no_playlists"),re(gpeByClass("_audio_page_titled_block",i)))}}}}),boxQueue&&boxQueue.hideAll(),layers&&layers.fullhide&&layers.fullhide(),each(geByClass("_audio_pl_"+e+"_"+t),function(){re(this)}),cur.audioPage&&(cur.audioPage._data.playlists=cur.audioPage._data.playlists.filter(function(i){return!(i.id==t&&i.owner_id==e)}),cur.audioPage.updatePlaylistsCounter&&cur.audioPage.updatePlaylistsCounter(e))}.bind(this),getLang("global_cancel"))},AudioPage.prototype.getCurrentSection=function(){return this._currentSection},AudioPage.prototype._initPlaylists=function(e){if(this._data.generic)return e&&e([]);AudioPage.loadPlaylists(this.getOwnerId(),this._data.playlistsTotal,!0,!1,function(t){this._data.playlists=this._data.playlists.concat(t),this._data.playlistsIndex=new vkIndexer(this._data.playlists,function(e){return e.title}),e&&e()}.bind(this))},AudioPage.prototype.getOwnerPlaylists=function(){return this._data.playlists},AudioPage.loadPlaylists=function(ownerId,totalCount,skipFirstChunk,forAttachBox,onDone){var chunkSize=50,chunks=[];isFunction(totalCount)&&(onDone=totalCount,totalCount=void 0,skipFirstChunk=!1),cur.playlistsCache=cur.playlistsCache||{};var cacheKey=ownerId+"_"+intval(skipFirstChunk);if(cur.playlistsCache[cacheKey])return onDone(cur.playlistsCache[cacheKey]);function onAllLoaded(){var e=[];each(chunks,function(t,i){i&&(e=e.concat(i))}),cur.playlistsCache[cacheKey]=e,onDone&&onDone(e)}function _loadChunk(chunkIndex,_cb){ajax.post("al_audio.php",{act:"owner_playlists",owner_id:ownerId,offset:chunkIndex*chunkSize,is_attach:forAttachBox?1:0},{onDone:function onDone(playlists,totalCount,additionalData){additionalData.templates_script&&eval(additionalData.templates_script),additionalData.langs&&extend(cur.lang,additionalData.langs),additionalData.audio_playlist_cover_upload_options&&(cur.audioCoverUploadOptions=cur.audioCoverUploadOptions||{},cur.audioCoverUploadOptions[ownerId]=additionalData.audio_playlist_cover_upload_options),chunks[chunkIndex]=playlists,_cb(totalCount)},onFail:function(e){if(hide(boxLoader),e)return showFastBox({title:getLang("global_error")},e),!0}})}function _loadAllChunks(e,t,i){var o=Math.ceil(e/chunkSize);if(o&&o-t!=0)for(var a=new callHub(i,o-t),s=t;s<o;s++)_loadChunk(s,function(){a.done()});else i()}isUndefined(totalCount)?_loadChunk(0,function(e){_loadAllChunks(e,1,onAllLoaded)}):_loadAllChunks(totalCount,skipFirstChunk?1:0,onAllLoaded)},AudioPage.prototype.getOwnerId=function(){return this._ownerId},AudioPage.prototype.getPageContainer=function(){return this._els.pageContainer},AudioPage.prototype.canAddToGroup=function(){return this._data.canAudioAddToGroup},AudioPage.prototype.canEditGroup=function(){return this._data.canEdit},AudioPage.prototype.updateCurrentPlayingInfo=function(){if(this.isLayer()){var e=getAudioPlayer().getCurrentPlaylist(),t=e?e.getTitle():"";if(t){var i,o,a,s=e.getOriginalPlaylistRawId();if(s||e.getType()==AudioPlaylist.TYPE_PLAYLIST&&e.getAlbumId()>0)s?(i=(s=s.split("_"))[0],o=s[1],a=s[2]||""):(i=e.getOwnerId(),o=e.getAlbumId(),a=e.getAccessHash()||""),t='<a href="'+nav.toStr(extend({},nav.objLoc,{z:"audio_playlist"+i+"_"+o+(a?"/"+a:"")}))+'" class="audio_page__footer_now_playing_link" onclick="if (checkEvent(event)) { return true } else { AudioUtils.showAudioPlaylist('+i+", "+o+", '"+a+"'); return cancelEvent(event) }\">"+t+"</a>";this._els.footerNowPlayingInfo.innerHTML=getLang("audio_current_playing_from").replace("{playlist}",t)}else{var r=getAudioPlayer().getCurrentAudio();AudioUtils.isPodcast(r)?this._els.footerNowPlayingInfo.innerHTML=getLang("audio_current_playing_from").replace("{playlist}",getLang("audio_podcast_playing").replace("{name}",r[AudioUtils.AUDIO_ITEM_INDEX_PERFORMER])):this._els.footerNowPlayingInfo.innerHTML=""}this._els.footerClearNowPlayingButton.innerHTML=getLang("audio_clear_current_playlist"),toggle(this._els.footer,!!e)}},AudioPage.prototype.onSearchFiltersChanged=function(e){var t=window.radioBtns["audio_search_type_"+intval(this.isLayer())],i=intval(this._searchSortFilter.selectedItems()[0][0]),o={performer:t.val?1:null,lyrics:hasClass(geByClass1("_audio_fltr_with_lyrics",this._els.pageContainer),"on")?1:null,sort:i?1:null};this.syncParametersUI(o);var a=e&&isObject(e)?e:o;this.isLayer()&&(a=extend({},this._prevLoc,a)),nav.change(a,!1,{fromSearch:!0,filtersChanged:!0})},AudioPage.prototype._initSearchParams=function(){window.radioBtns["audio_search_type_"+intval(this.isLayer())]={els:geByClass("_audio_search_type",this._els.pageContainer),keep:this.isLayer()};var e=geByClass1("_audio_fltr_sort",this._els.pageContainer);e&&(this._searchSortFilter=new Dropdown(e,this._data.sortFilters,{big:1,zeroPlaceholder:!0,onChange:this.onSearchFiltersChanged.bind(this)})),this.isLayer()||this.syncParametersUI(nav.objLoc)},AudioPage.prototype.syncParametersUI=function(e){var t="audio_search_type_"+intval(this.isLayer()),i=window.radioBtns[t];i&&radiobtn(i.els[e.performer?1:0],!!e.performer,t);var o=geByClass1("_audio_fltr_with_lyrics",this._els.pageContainer);toggleClass(o,"on",!!e.lyrics);var a={performer:AudioPlayer.getLang("audio_performers_only"),lyrics:AudioPlayer.getLang("audio_search_with_text"),sort:AudioPlayer.getLang("audio_search_by_length")},s=this._els.searchInput;each(["performer","lyrics","sort"],function(t,i){uiSearch.toggleFilter(s,i,a[i],!!e[i])})},AudioPage.onFilterRemoved=function(e,t,i){var o=currentAudioPage(t);(function(){switch(e){case"performer":var t="audio_search_type_"+intval(this.isLayer()),o=window.radioBtns[t];radiobtn(o.els[0],0,t);break;case"sort":var a=this._searchSortFilter.options.defaultItems[0][0];this._searchSortFilter.selectItem(a,!1);break;case"lyrics":removeClass(geByClass1("_audio_fltr_with_lyrics",this._els.pageContainer),"on")}i||this.onSearchFiltersChanged()}).apply(o)},AudioPage.prototype._showSearchSection=function(e){this._toggleSearchProgress(!0);var t=getAudioPlayer().getPlaylist(AudioPlaylist.TYPE_PLAYLIST,this.getOwnerId(),AudioPlaylist.DEFAULT_PLAYLIST_ID);if(geByClass1("audio_page_player2")){var i=e.globalQuery||e.q;this._sectionData={q:i,performer:e.performer},this.showSection("search",function(){i&&Object(_lib_stats__WEBPACK_IMPORTED_MODULE_0__.a)("audio",0,!isVisible(this._els.searchNoLocalResults)),this._toggleSearchProgress(!1)}.bind(this))}else t.loadAll(function(){this._toggleSearchProgress(!1),this._doShowSearchSection(e)}.bind(this))},AudioPage.prototype._toggleSearchProgress=function(e){this._els.searchInput&&(e?uiSearch.showProgress(this._els.searchInput):uiSearch.hideProgress(this._els.searchInput))},AudioPage.prototype._doShowSearchSection=function(e){var t=getAudioPlayer();if(e&&(this._prevSearchParams=e),e=e||this._prevSearchParams){var i=replaceEntities(e.q)+replaceEntities(e.globalQuery||"");each(["performer","lyrics","sort"],function(t,o){i+=e[o]||0}),i+=this._ownerId,this._toggleSearchProgress(!0);var o=getAudioPlayer().getPlaylist(AudioPlaylist.TYPE_PLAYLIST,this._ownerId,AudioPlaylist.DEFAULT_PLAYLIST_ID);o.loadAll(function(){clearTimeout(this._onSilendLoadedTO),this._onSilendLoadedTO=setTimeout(function(){(function(){o.search(e,function(o){var a="";this._searchAudiosAutoList&&(this._els.searchSectionAudios.innerHTML="",this._searchAudiosAutoList.destroy());var s=this._data.playlistsIndex?this._data.playlistsIndex.search(e.q):[];if(this.showSection("search"),s.length){var r="";each(s,function(e,t){r+=getTemplate("audio_pl_item",t)}),show(this._els.searchSectionPlaylistsHeader),show(this._els.searchSectionPlaylists),a=this._ownerId==vk.id?t.langs.audio_found_your_local_playlists:this._ownerId>0?t.langs.audio_found_user_local_playlists:t.langs.audio_found_group_local_playlists,this._els.searchSectionPlaylistsHeader.innerHTML=langNumeric(s.length,a),this._els.searchSectionPlaylists.innerHTML=r}else hide(this._els.searchSectionPlaylistsHeader),hide(this._els.searchSectionPlaylists);var l=getAudioPlayer().getPlaylist(AudioPlaylist.TYPE_SEARCH,vk.id,hashCode(i));l.mergeWith({list:o,searchParams:{globalQuery:e.globalQuery||e.q,performer:e.performer,lyrics:e.lyrics,sort:e.sort}}),l.setLocalFoundCount(o.length),o.length||s.length?hide(this._els.searchNoLocalResults):(show(this._els.searchNoLocalResults),a=vk.id==this._ownerId?t.langs.audio_no_local_results:this._ownerId>0?t.langs.audio_no_user_local_results:t.langs.audio_no_group_local_results,this._els.searchNoLocalResults.innerHTML=a.replace("{query}","<strong>"+clean(e.q)+"</strong>")),o.length||(hide(this._els.searchSectionAudiosHeader),hide(this._els.searchSectionAudios)),this._searchAudiosAutoList=new AutoList(this._els.searchSectionAudios,{onNeedRows:function(e,i,s,r,n){this._toggleSearchProgress(!0),l.load(i,function(){if(this._toggleSearchProgress(!1),!n.isDone()){if(0==i&&(o.length?(show(this._els.searchSectionAudiosHeader),show(this._els.searchSectionAudios),a=this._ownerId==vk.id?t.langs.audio_found_your_local:this._ownerId>0?t.langs.audio_found_user_local:t.langs.audio_found_group_local,this._els.searchSectionAudiosHeader.innerHTML=langNumeric(o.length,a),toggleClass(this._els.searchSectionAudios,"audio_owner_list_canedit",!!this._data.canEdit)):(hide(this._els.searchSectionAudiosHeader),hide(this._els.searchSectionAudios)),hide(this._els.searchGlobalCommunitiesPlace),hide(this._els.searchGlobalPlaylistsPlace),hide(this._els.searchGlobalArtistsPlace)),i==o.length){var s=l.getCommunititesBlock(),r=l.getPlaylistsBlock(),d=l.getArtistsBlock();toggle(this._els.searchGlobalCommunitiesPlace,!!s),toggle(this._els.searchGlobalPlaylistsPlace,!!r),toggle(this._els.searchGlobalArtistsPlace,!!d),this._els.searchGlobalCommunitiesPlace&&(this._els.searchGlobalCommunitiesPlace.innerHTML=s||""),this._els.searchGlobalPlaylistsPlace&&(this._els.searchGlobalPlaylistsPlace.innerHTML=r||""),this._els.searchGlobalArtistsPlace&&(this._els.searchGlobalArtistsPlace.innerHTML=d||""),this._els.searchGlobalAudiosList.innerHTML="",l.getAudiosCount()>o.length?(show(this._els.searchGlobalAudiosBlock),n.setListEl(this._els.searchGlobalAudiosList),this._els.searchGlobalAudiosBlockHeader.innerHTML=langNumeric(l.getTotalCount(),t.langs.audio_global_search_found,!0)):hide(this._els.searchGlobalAudiosBlock)}for(var u=[],_=l.getAudiosList(),c=i,h=i<o.length?Math.min(o.length,i+30):i+30,g=c;g<h&&_[g];g++)u.push(AudioUtils.drawAudio(_[g]));e(u)}}.bind(this))}.bind(this)}),this._onSectionOut(function(){this._els.searchSectionAudios.innerHTML="",this._searchAudiosAutoList&&(this._searchAudiosAutoList.destroy(),this._searchAudiosAutoList=!1)}.bind(this)),this._pagePlaylist=l,this._toggleSearchProgress(!1)}.bind(this))}).call(this)}.bind(this))}.bind(this))}},AudioPage.prototype.showFriendMusic=function(e,t){return this.isLayer()?nav.go({0:"/audios"+t},!1,{friendId:t}):nav.go("/audios"+t,e),cancelEvent(e)},AudioPage.prototype._deinitNavigation=function(){cur.nav.pop(),this._navigationInited=!1},AudioPage.PageSections=["recoms_audio","recoms_block","search_block","recoms_personal"],AudioPage.prototype.initNavigation=function(){this._navigationInited||this.isPodcastPage()||(this._navigationInited=!0,this._prevLoc={},cur.nav.push(function(e,t,i,o){var a=this._ignoreResetedSearch;if(delete this._ignoreResetedSearch,a&&o.fromSearch)return!1;if(this.isLayer()&&!1!==this._prevLoc)for(var s in t=clone(this._prevLoc),e=clone(i),t)t.hasOwnProperty(s)&&(t[s]&&void 0===i[s]?e[s]=!1:t[s]==i[s]&&delete e[s]);if(e&&Object.keys(e).length){this._deleteDeletedAudios();var r=i.section||"all",l=!1;return 0===i[0].indexOf("podcasts")&&(r="podcast"),o.tab?l=!1:o.fromSearch?l=!1:!1===e.q&&1==Object.keys(e).length?l=!1:o.searchPerformer?l=!1:o.friendId&&this.isLayer()?(r="friend",this.resetSection(r),this._sectionData={friend_id:o.friendId},l=!1):(2!=Object.keys(e).length||!1!==e.q||isUndefined(e[0]))&&isUndefined(e[0])?(inArray(e.section,AudioPage.PageSections)||inArray(t.section,AudioPage.PageSections)&&!inArray(e.section,AudioPage.PageSections))&&(this.isLayer()&&"search_playlists"!==i.section?(l=!1,this._sectionData={audio_id:e.audio_id},r="recoms",delete this._currentSection):l=!0):l=!0,l?!0:("recoms"==r&&this.isLayer()&&this.resetSection("recoms"),i.q?(this._els.searchInput&&!o.fromSearch&&(this._els.searchInput.value=i.q),this._showSearchSection(extend({},i,o))):(this._ignoreResetedSearch=!1===e.q,uiSearch.reset(this._els.searchInput,!0),this.showSection(r),this._switchTab(r)),this.isLayer()?this._prevLoc=i:nav.setLoc(i),(o.back||o.hist||o.nav)&&this.syncParametersUI(i),!1)}}.bind(this)))},AudioPage.prototype._deleteDeletedAudios=function(){var e=AudioUtils.getAddRestoreInfo();each(e,function(e,t){"deleted"!=t.state&&"recom_hidden"!=t.state||getAudioPlayer().deleteAudioFromAllPlaylists(e)})},AudioPage.prototype._switchTab=function(e){if(!this.isPodcastPage()){var t=geByClass1("_audio_section_tab__"+e,this._els.pageContainer);t?uiTabs.switchTab(domFC(t)):removeClass(geByClass1("ui_tab_sel",this._els.pageContainer),"ui_tab_sel")}},AudioPage.prototype.onLayerHide=function(){this._deinitNavigation(),this._deinitKeyEvents(),this._onSectionOut(),delete this._currentSection,this._muteSearch=!0,geByClass1("audio_page_player2")&&hide(this._els.searchNoLocalResults),uiSearch.reset(this._els.searchInput,!0)},AudioPage.prototype.updateLayerHeight=function(){var e=700;e=Math.min(e,window.innerHeight-150),e=Math.max(e,400),isVisible(this._els.footer)&&(e-=getSize(this._els.footer)[1]),setStyle(this._els.scrollWrap,{height:e})},AudioPage.prototype.onLayerShow=function(e){var t=getAudioPlayer().getCurrentPlaylist(),i=AudioUtils.isPodcast(getAudioPlayer().getCurrentAudio());i?this.showSection("podcast"):t?this.showSection("current"):e?this.showSection(e):this.showSection("all"),toggleClass(geByClass1("_audio_section_tab__current",this._els.pageContainer),"unshown",!t||i),this.initNavigation(),this.updateCurrentPlayingInfo(),this._initKeyEvents(),this.updateLayerHeight(),this.updateShuffleButton();var o=this.getPageCurrentPlaylist(),a=getAudioPlayer().getCurrentAudio();if(this._audioRowsAutoList&&o&&a&&o.indexOfAudio(a)>=0)for(var s=10;s--;){var r=geByClass1(AudioUtils.AUDIO_CURRENT_CLS,this._audioRowsAutoList.getListEl());if(r){var l=getXY(r)[1];this._scroll.scroller.scrollTop=l-scrollGetY()-300;break}this._audioRowsAutoList.drawMore(),getAudioPlayer().updateCurrentPlaying()}this._scroll.update(),delete this._muteSearch},AudioPage.prototype.resetSection=function(e){var t=geByClass1("_audio_section__"+e,this._els.sections);re(t)},AudioPage.prototype.showSection=function(e,t,i){this.isPodcastPage()&&(e="podcast"),"search"!==this._currentSection||"all"!==e&&"current"!==e||uiSearch.reset(this._els.searchInput,!0),layers.fullhide&&layers.fullhide(),this._switchTab(e);var o=geByClass1("audio_page_player2")&&"search"===e;if(this._currentSection!==e||"search"===this._currentSection){this._currentSection=e;var a=geByClass1("_audio_section__"+e,this._els.sections),s=this._data.sectionData&&this._data.sectionData[e]||{};if(a&&(!o||!1===i)){if(each(geByClass("_audio_section",this._els.pageContainer),function(){hide(this)}),hide(this._els.searchGlobalBlocks),hide(this._els.searchGlobalCommunitiesPlace),hide(this._els.searchGlobalPlaylistsPlace),hide(this._els.searchGlobalArtistsPlace),hide(this._els.searchGlobalAudiosBlock),toggle(this._els.recomsBlocks,"recoms"===e&&!this.isLayer()),toggle(this._els.searchBlocks,"search"===e),show(a),geByClass1("audio_page_player2")&&(hide(this._els.searchNoLocalResults),"search"===e&&!a.innerHTML)){show(this._els.searchNoLocalResults);var r=vk.id==this._ownerId?ap.langs.audio_no_local_results:this._ownerId>0?ap.langs.audio_no_user_local_results:ap.langs.audio_no_group_local_results,l=winToUtf(clean(s.searchParams.globalQuery));this._els.searchNoLocalResults.innerHTML=r.replace("{query}","<strong>"+l+"</strong>")}switch(this._onSectionOut(),delete cur._back,e){case"current":this._initSection_all(a,s,!0);break;case"friend":this._initSection_all(a,s);break;case"playlists":this._initSection_playlists(a,s);break;case"updates":this._initSection_updates(a,s);break;case"recoms":this.isLayer()||vk.id!=this.getOwnerId()?this._initSection_all(a,s):this._initSection_recoms(a,s);break;case"search":o&&this._initSection_search(a,s);break;case"all":case"recoms_audio":case"recoms_block":case"search_block":s.isRecomsPlaylists?this._initSection_playlistsRecoms(a,s):this._initSection_all(a,s);break;case"podcast":this._initSection_podcast(a,s)}return getAudioPlayer().updateCurrentPlaying(),void(isFunction(t)&&t())}var n=this._ownerId;if("podcast"===e&&!this.isPodcastPage())n=(getAudioPlayer().getCurrentAudio()||this._readyAudio)[AudioUtils.AUDIO_ITEM_INDEX_OWNER_ID];ajax.post("al_audio.php",extend({act:"section",section:e,owner_id:n,is_layer:this.isLayer()?1:0,claim:intval(nav.objLoc.claim)},this._sectionData||{}),{onDone:function(i,a,s){if(this._data.sectionData=this._data.sectionData||{},this._data.sectionData[e]=a,o){var r=geByClass1("_audio_section__"+e,this._els.sections);r&&re(r)}var l=se('<div class="audio_section _audio_section _audio_section__'+e+" audio_section__"+e+' clear_fix audio_w_covers">'+i+"</div>");this._els.sections.appendChild(l),s||(s=""),"recoms"===e&&(this._els.recomsBlocks.innerHTML=s),"search"===e&&(this._els.searchBlocks.innerHTML=s),delete this._currentSection,this.showSection(e,t,!1)}.bind(this)}),delete this._sectionData}else isFunction(t)&&t()},AudioPage.prototype._onSectionOut=function(e){e?(this._onSectionOutCbs=this._onSectionOutCbs?this._onSectionOutCbs:[],this._onSectionOutCbs.push(e)):(each(this._onSectionOutCbs||[],function(e,t){t()}),this._onSectionOutCbs=[])},AudioPage.prototype._initSection_search=function(e,t){each(t.playlists||[],function(e,i){if(i){i.searchParams=t.searchParams;var o=getAudioPlayer().getPlaylist(i.type,i.ownerId,i.id);0==o.getAudiosList()&&o.mergeWith(i)}})},AudioPage.prototype._initSection_playlistsRecoms=function(e,t){var i=geByClass1("audio_page_block__playlists_items",e);if(i){var o=t.playlistsData.next,a=3,s=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;a?(a--,setTimeout(function(){r(e,2*t)},t)):e([])},r=function(e,i){ajax.post("al_audio.php",{act:"load_playlists_block",block_id:t.playlistsData.id,offset:o,render_html:1},{onDone:function(t,r){t&&r&&r.length?(a=3,o=t.next,e(r)):s(e,i)},onFail:function(){s(e,i)}})},l=new AutoList(i,{onNeedRows:function(e){if(!i.clientHeight)return l&&l.destroy();o?r(e):e([])},onNoMore:function(){l&&l.toggleProgress(!1)},showProgress:showProgress.pbind(i,"","audio_more_rows"),hideProgress:hideProgress.pbind(i)});this._onSectionOut(function(){l.destroy()})}},AudioPage.prototype._initSection_recoms=function(e,t){function i(e){each(e.playlists||[],function(e,t){if(t){var i=getAudioPlayer().getPlaylist(t.type,t.ownerId,t.id);0==i.getAudiosList()&&i.mergeWith(t)}})}if(i(t),vk.id==this.getOwnerId()){var o=0,a=new AutoList(this._els.recomsBlocks,{onNeedRows:function(e){o+=4,ajax.post("al_audio.php",{act:"recoms_blocks",offset:o},{onDone:function(t,o){isArray(t)?(t=t.filter(function(e){return!!trim(e)}),i(o),e(t)):e(!1)}})}});this.isLayer()||(cur._back={loc:"audios"+this.getOwnerId()+"?section=recoms",text:"Recoms"}),this._onSectionOut(function(){a.destroy()})}},AudioPage.prototype._initSection_playlists=function(e,t){var i=geByClass1("_audio_page_block__playlists_items",e);i.innerHTML="";var o,a=new AutoList(i,{uiScroll:this.isLayer(),onNeedRows:function(e,t){for(var i=[],o=this._data.playlists,a=t;a<t+20&&o[a];a++)i.push(getTemplate("audio_pl_item",o[a]));e(i)}.bind(this)});this._data.canEdit&&(o=new GridSorter(i,"audio_pl_item2",{onReorder:function(e,t,i){var o=domData(e,"raw-id"),a=domData(i,"raw-id");ajax.post("al_audio.php",{act:"reorder_playlist",owner_id:this.getOwnerId(),playlist_id:o.split("_")[1],prev_playlist_id:a?a.split("_")[1]:0,hash:this._data.reorderHash})}.bind(this)}),this._onSectionOut(function(){a.destroy(),o&&o.destroy()}))},AudioPage.prototype._initSection_updates=function(e,t){if(uiSearch.init(geByClass1("_audio_friends_search",e)),t.feedPlaylist){var i=getAudioPlayer().getPlaylist(AudioPlaylist.TYPE_FEED,vk.id,0);i.getFeedOffset()||i.mergeWith(t.feedPlaylist);var o=e;o.innerHTML="",this._pagePlaylist=i,domData(gpeByClass("_audio_pl",o),"playlist-id",i.getId());var a=new AutoList(o,{onNeedRows:function(e,t){i.load(t,function(){e(i.getItemsList().slice(t))})}});this._onSectionOut(function(){a.destroy()})}},AudioPage.prototype._initSection_all=function(e,t,i){var o=this;extend(this._els,{audioRows:geByClass1("_audio_page__audio_rows_list",e),audioRowsMore:geByClass1("_audio_more_rows",e),friendsBlock:geByClass1("_audio_friends_list_wrap",e),friendsBlockContent:geByClass1("_audio_friends_list_content",e)});var a=void 0;if(i)a=getAudioPlayer().getCurrentPlaylist();else{var s=t.playlistData;(a=getAudioPlayer().getPlaylist(s.type,s.ownerId,s.id)).mergeWith(s),a.getAudiosCount()||a.load()}a&&(this._pagePlaylist=a,domData(this._els.audioRows,"playlist-id",a.getId()));var r=geByClass1("_audio_friends_search",e);if(r&&uiSearch.init(r),!this._sortDD&&!i){var l=geByClass1("_audio_page__sort_dd",e);if(l&&isVisible(l)){var n=getLang("audio_sort_types").split("<br>");this._sortDD=new InlineDropdown(l,{items:[[0,n[0]],["performer",n[1]],["random",n[2]],["reverse",n[3]]],withArrow:!0,selected:0,onSelect:this._onSortSelected.bind(this)})}}this._initAudioRowsAutoList(i),this._enableAudioRowsSorter(i),setTimeout(function(){return o._initFixedFriendsBlock(e)})},AudioPage.prototype._initSection_podcast=function(e,t){extend(this._els,{audioRows:geByClass1("_audio_page__audio_rows_list",e),audioRowsMore:geByClass1("podcast_episodes_more",e)});var i=getAudioPlayer().getCurrentPlaylist();if(!i){var o=t.playlistData;o&&((i=getAudioPlayer().getPlaylist(o.type,o.ownerId,o.id)).getAudiosCount()||(i.mergeWith(o),i.load()))}i&&(this._pagePlaylist=i,domData(this._els.audioRows,"playlist-id",i.getId())),this._initAudioRowsAutoList(),this._data.reverse||this._enableAudioRowsSorter()},AudioPage.prototype.getSortedList=function(){return this._sortedList},AudioPage.prototype.shuffleAudioPage=function(){if(!this.isPodcastPage()){var e=this.getPageCurrentPlaylist(),t=domData(this._els.audioRows,"audio-context");e.loadAll(function(){this._sortedList=[].concat(e.getUnshuffledAudiosList()),shuffle(this._sortedList);var i=new AudioPlaylist(AudioPlaylist.TYPE_TEMP);i.mergeWith({list:this._sortedList}),getAudioPlayer().play(i.getAudioAt(0),i,t),this._disableAudioRowsSorter(),this._initAudioRowsAutoList(),this._sortDD&&this._sortDD.select("random",!0)}.bind(this)),statlogsValueEvent("audio_sort_stat","audio_sort","shuffle_page",this.isLayer()?"layer":"page")}},AudioPage.prototype._onSortSelected=function(e){var t=this.getPageCurrentPlaylist();t.loadAll(function(){switch(e){case 0:delete this._sortedList,this._enableAudioRowsSorter(),statlogsValueEvent("audio_sort_stat","audio_sort","dropdown_default");break;case"performer":var i=[].concat(t.getUnshuffledAudiosList());i.sort(function(e,t){var i=trim(e[AudioUtils.AUDIO_ITEM_INDEX_PERFORMER].toLowerCase()),o=trim(t[AudioUtils.AUDIO_ITEM_INDEX_PERFORMER].toLowerCase());return 0==i.indexOf("the ")&&(i=i.slice(4)),0==o.indexOf("the ")&&(o=o.slice(4)),i<o?-1:i>o?1:0}),this._sortedList=i,this._disableAudioRowsSorter(),statlogsValueEvent("audio_sort_stat","audio_sort","dropdown_performer");break;case"random":this._sortedList=[].concat(t.getUnshuffledAudiosList()),shuffle(this._sortedList),this._disableAudioRowsSorter(),statlogsValueEvent("audio_sort_stat","audio_sort","dropdown_shuffle");break;case"reverse":this._sortedList=[].concat(t.getUnshuffledAudiosList()),this._sortedList.reverse(),this._disableAudioRowsSorter(),statlogsValueEvent("audio_sort_stat","audio_sort","dropdown_reverse")}this._initAudioRowsAutoList()}.bind(this))},AudioPage.prototype._initFixedFriendsBlock=function(){var e=this;if(this._els.friendsBlock){var t,i,o=!1,a=getXY(this._els.friendsBlock),s=void 0,r=this.isLayer(),l=getSize("page_header")[1],n=getSize(this._els.playerWrap)[1],d=r?13:15,u=a[1]-l-n-d,_=r?this._scroll.scroller:window;u<0||(addEvent(window,"resize",i=function(){a=getXY(e._els.friendsBlock)}),addEvent(_,"scroll",t=function(){var t=(r?e._scroll.scroller.scrollTop+scrollGetY():scrollGetY())>u;t&&!o&&(a=getXY(e._els.friendsBlock),addClass(e._els.friendsBlockContent,"audio_friends_fixed"),o=!0,e.isLayer()&&(s=addEvent(e._els.friendsBlockContent,"mousewheel",function(t){return e._scroll.scroller.scrollTop=e._scroll.scroller.scrollTop+t.deltaY,cancelEvent(t)}))),!t&&o&&(removeClass(e._els.friendsBlockContent,"audio_friends_fixed"),o=!1,s&&removeEvent(e._els.friendsBlockContent,"mousewheel",s))}),this._onSectionOut(function(){t&&removeEvent(_,"scroll",t),i&&removeEvent(window,"resize",i),s&&removeEvent(e._els.friendsBlockContent,"mousewheel",s),removeClass(e._els.friendsBlockContent,"audio_friends_fixed")}))}},AudioPage.prototype.playPlaylist=function(e,t,i,o){var a=getAudioPlayer(),s=a.getCurrentPlaylist(),r=a.getPlaylist(e,t,i);s&&s.equals(r)&&a.isPlaying()?a.pause():r.load(0,function(){a.play(r.getAudiosList()[0],r,o)})},AudioPage.prototype._enableAudioRowsSorter=function(e){(this._data.audiosReorderHash||e)&&(this._audioRowsSorter&&this._audioRowsSorter.destroy(),this._audioRowsSorter=new GridSorter(this._els.audioRows,"",{wrapNode:this.isLayer()?this._scroll.scroller:void 0,onReorder:function(t,i,o){var a=getAudioPlayer(),s=domData(t,"full-id"),r=domData(o,"full-id"),l=e?a.getCurrentPlaylist():this.getPageCurrentPlaylist(),n=l.indexOfAudio(s),d=void 0;r?(d=l.indexOfAudio(r),d+=1):d=0,l.moveAudio(n,d),e&&a.saveStateCurrentPlaylist(),this.isPodcastPage()?ajax.post("al_podcasts.php",{act:"a_reorder_episodes",hash:this._data.audiosReorderHash,oid:this.getOwnerId(),episode_id:s?s.split("_")[1]:0,next_episode_id:r?r.split("_")[1]:0}):e||ajax.post("al_audio.php",{act:"reorder_audios",hash:this._data.audiosReorderHash,owner_id:this.getOwnerId(),audio_id:s?s.split("_")[1]:0,next_audio_id:r?r.split("_")[1]:0})}.bind(this)}),this._onSectionOut(function(){this._audioRowsSorter&&this._audioRowsSorter.destroy()}.bind(this)))},AudioPage.prototype._disableAudioRowsSorter=function(){this._audioRowsSorter&&this._audioRowsSorter.disable()},AudioPage.prototype._initAudioRowsAutoList=function(e){if(this._els.audioRows){var t=this.isPodcastPage()||"podcast"===this._currentSection,i=this._pagePlaylist;this._els.audioRows.innerHTML="",toggleClass(this._els.audioRows,"audio_owner_list_canedit",!t&&!!this._data.canEdit),this._audioRowsAutoList&&this._audioRowsAutoList.destroy(),this._audioRowsAutoList=new AutoList(this._els.audioRows,{scrollNode:!!this._scroll&&this._scroll.scroller,onRendered:function(){getAudioPlayer().updateCurrentPlaying()},onNoMore:function(){hide(this._els.audioRowsMore)}.bind(this),onNeedRows:function(o,a,s,r,l){var n=this,d=[];t?(lockButton(this._els.audioRowsMore),this._loadPodcastEpisodes(a,function(e){(e||[]).slice(a).forEach(function(e){d.push(AudioUtils.drawAudio(e))}),unlockButton(this._els.audioRowsMore),o(d)}.bind(this))):i&&i.load(a,function(){var t=[];t=e?i.getAudiosList():n._sortedList?n._sortedList:i.getUnshuffledAudiosList();for(var s=a;s<a+30&&t[s];s++)d.push(AudioUtils.drawAudio(t[s]));o(d),0===a&&n._audioRowsSorter&&n._audioRowsSorter.update(),0===a&&1===d.length&&l.drawMore()})}.bind(this)}),this._onSectionOut(function(){this._audioRowsAutoList.destroy(),this._els.audioRows.innerHTML=""}.bind(this))}},AudioPage.prototype._loadPodcastEpisodes=function(e,t){var i,o=getAudioPlayer().getCurrentAudio()||this._readyAudio;i=this.isPodcastPage()?this._ownerId:o[AudioUtils.AUDIO_ITEM_INDEX_OWNER_ID],cur._podcastsEpisodes=cur._podcastsEpisodes||{},cur._podcastsEpisodes[i]=cur._podcastsEpisodes[i]||[];var a=cur._podcastsEpisodes[i];a.length&&e<a.length?t(a):ajax.post("al_podcasts.php",{act:"a_episodes",oid:i,episode_full_id:o?o[AudioUtils.AUDIO_ITEM_INDEX_OWNER_ID]+"_"+o[AudioUtils.AUDIO_ITEM_INDEX_ID]:"",offset:e,rev:this._data.reverse},{onDone:function(e){cur._podcastsEpisodes[i]=a.concat(e||[]),t(cur._podcastsEpisodes[i])},onFail:function(){t(cur._podcastsEpisodes[i])}})},AudioPage.showAttachBox=function(e,t){1===vk.widget?showBox("al_audio.php",{act:"choose_box",owner_id:e,options:JSON.stringify(t)}):AudioPage.editPlaylist(e,AudioPlaylist.DEFAULT_PLAYLIST_ID,"attach",t)},AudioPage.editPlaylist=function(e,t,i,o){if(vk.widget)for(var a in o)o.hasOwnProperty(a)&&(isString(o[a])?o[a]=clean(o[a]):isFunction(o[a])?delete o[a]:o[a]=intval(o[a]));var s,r;if("edit"==i&&o&&(o.audioAttachSwitchOwnerId=!1),o&&o.audioAttachSwitchOwnerId&&(cur.audioAttachSwitchOwnerId=o.audioAttachSwitchOwnerId),i=i||"edit",t)s=getAudioPlayer().getPlaylist(AudioPlaylist.TYPE_PLAYLIST,e,t);else if(cur.audioPage){var l=cur.audioPage._data.maxPlaylistsCount;if(isArray(cur.audioPage._data.playlists)&&cur.audioPage._data.playlists.length>=l){var n=langNumeric(l,cur.lang.audio_playlists_limit_error).replace("{limit}",l);return void new MessageBox({title:getLang("global_error")}).content(n).setButtons("Ok",function(){curBox().hide()}).show()}}show(boxLoader),show(boxLayerWrap),boxRefreshCoords(boxLoader),parallel(function(e){stManager.add(["audio.css","indexer.js","auto_list.js","grid_sorter.js","edit"==i&&"upload.js"],e)},function(e){s?s.loadAll(e):e()},function(t){cur.audioPage&&cur.audioPage.getOwnerId()==e&&(r=cur.audioPage.getOwnerPlaylists()),r?t():AudioPage.loadPlaylists(e,void 0,!1,"attach"==i,function(e){r=e,t()})},function(){AudioPage._openEditPlaylist(i,e,t,r,o)})},AudioPage._openEditPlaylist=function(e,t,i,o,a){var s;hide(boxLoader),curBox()||hide(boxLayerWrap),cur.apLayer&&(s=cur.apLayerPlaylistId,layers.fullhide()),a=extend({audioPickerButtonText:getLang("global_add_media"),playlistPickerButtonText:getLang("audio_attach_playlist_button"),canPlaylistAttach:!1,onAudioChoose:AudioUtils.onAudioChoose,onPlaylistChoose:AudioUtils.onPlaylistChoose},a),cur.onChooseAudio=a.onAudioChoose,cur.onChoosePlaylist=a.onPlaylistChoose;var r,l=!i||i==AudioPlaylist.DEFAULT_PLAYLIST_ID,n=getAudioPlayer(),d=!1,u=!1,_=!1,c=!1,h=!1,g=!1,p=0,y=null;o=o.filter(function(e){return e.id!==AudioPlaylist.DEFAULT_PLAYLIST_ID&&e.size>0});var f,A=new vkIndexer(o,function(e){return e.title}),P=o.length>0,v=!1,w=n.getPlaylist(AudioPlaylist.TYPE_TEMP,t,irand(0,999999));if(l&&"attach"!=e?a.addAudio&&w.addAudio(a.addAudio):(v=n.getPlaylist(AudioPlaylist.TYPE_PLAYLIST,t,i),w.addAudio(v.getUnshuffledAudiosList()),w.mergeWith({title:v.getTitle(),description:v.getDescription(),rawDescription:v.getRawDescription(),coverUrl:v.getCoverUrl(),editHash:v.getEditHash()})),f="attach"==e?getLang("audio_choose_audio_title"):i?getLang("audio_edit_playlist_title"):getLang("audio_new_playlist_title"),(2===vk.widget||3===vk.widget)&&window.box&&!boxQueue.count()&&!curBox()){(m=window.box).setOptions({title:f,bodyStyle:"padding: 0",width:560,onBeforeHide:S,onHideAttempt:L,hideButtons:!0})}else{cur.audioChooseBox&&cur.audioChooseBox==curBox()&&curBox().hide();var m=new MessageBox({title:f,bodyStyle:"padding: 0",width:560,onBeforeHide:S,onHideAttempt:L});cur.audioChooseBox=m}m.content(getTemplate("audio_edit_playlist")),m.show();var C={boxContent:geByClass1("_audio_pl_edit_box",m.bodyNode),playlistNameInput:geByClass1("ape_pl_input",geByClass1("ape_pl_title",m.bodyNode)),playlistDescriptionInput:geByClass1("ape_pl_input",geByClass1("ape_pl_description",m.bodyNode)),stat:geByClass1("_ape_pl_stat",m.bodyNode),uploadCoverButton:geByClass1("_ape_cover",m.bodyNode),uploadCoverInput:geByClass1("_ape_cover_upload",m.bodyNode),errorMsg:geByClass1("_ape_error_msg",m.bodyNode),header:geByClass1("_ape_header",m.bodyNode),search:geByClass1("_ape_search",m.bodyNode),searchInput:geByClass1("_field",m.bodyNode),addAudiosButton:geByClass1("ape_add_audios_btn",m.bodyNode),addAudiosFromPlaylistsButton:geByClass1("ape_add_pl_audios_btn",m.bodyNode),listWrap:geByClass1("_ape_list_wrap",m.bodyNode),list:geByClass1("_ape_item_list",m.bodyNode),globalResults:geByClass1("_ape_item_global_results",m.bodyNode),globalResultsList:geByClass1("_ape_item_global_list",m.bodyNode),emptyPlaceholder:geByClass1("_ape_audios_empty_list",m.bodyNode),emptyPlaylistsPlaceholder:geByClass1("_ape_audios_empty_playlists_list",m.bodyNode),emptyGlobalPlaceholder:geByClass1("_ape_audios_empty_global_list",m.bodyNode)};function b(e){if(e=trim(e)){var t=" "+(e+"|")+(parseLatin(e)||"")+(parseCyr(e)||"");t=trim(t.replace(/\)/g,"").replace(/&/,"&amp;")),g=new RegExp("(\\s|^)("+t.replace(vkIndexer.delimiter,"|").replace(/(^\||\|$|\?)/g,"")+")","gi")}else g=!1;D(c,"playlists"!==_,e),hide(C.emptyGlobalPlaceholder)}function S(){w.clean(),n.deletePlaylist(w),s&&AudioUtils.showAudioPlaylist(s[0],s[1])}function L(t){return!(!t&&"attach"!==e&&!i)||(showFastBox(getLang("global_warning"),getLang("audio_new_playlist_remove_confirm_text"),getLang("audio_new_playlist_remove_confirm_continue"),function(){curBox().hide(),m.hide(!0)},getLang("global_cancel")),!1)}function E(){return trim(C.searchInput.value)}function I(t){var i=w.indexOfAudio(t)>=0?"ape_selected":"",o=t;g&&((t=clone(o))[AudioUtils.AUDIO_ITEM_INDEX_TITLE]=t[AudioUtils.AUDIO_ITEM_INDEX_TITLE].replace(g,"$1<em>$2</em>"),t[AudioUtils.AUDIO_ITEM_INDEX_PERFORMER]=t[AudioUtils.AUDIO_ITEM_INDEX_PERFORMER].replace(g,"$1<em>$2</em>"));var s="";if("edit"==e)s='<div class="ape_check"><div class="ape_check_icon"></div></div>';else{var r=AudioUtils.asObject(o);if(a&&a.wiki)s='<div role="button" class="ape_attach" onclick="'+("editorChooseAudio('"+clean(r.performer)+"', '"+clean(r.title)+"', "+r.duration+", '"+r.fullId+"', '"+r.url+"', "+r.duration+", this)")+'">'+a.audioPickerButtonText+"</div>";else s='<div role="button" class="ape_attach" onclick="cur.onChooseAudio(event, this, '+(r=clean(JSON.stringify(r)))+", "+clean(JSON.stringify(o))+')">'+a.audioPickerButtonText+"</div>"}return'<div class="ape_audio_item_wrap _ape_audio_item '+i+'">'+s+AudioUtils.drawAudio(t)+"</div>"}!function(){var i=window.innerHeight;setStyle(C.boxContent,"height",Math.min(800,Math.max(i-200,500))),addEvent(C.addAudiosFromPlaylistsButton,"click",U.bind(this,"playlists")),addEvent(C.addAudiosButton,"click",U.bind(this,"default")),addEvent(C.list,"click",M),"attach"==e&&domData(C.list,"audio-context","attach");addEvent(m.titleWrap,"click",function(e){hasClass(e.target,"_back")&&function(){switch(_){case"initial":break;case"default":U("initial");break;case"playlists":U("default");break;case"playlist":U("playlists")}}()}),uiSearch.init("ape_edit_playlist_search",{onChange:b}),"edit"==e&&(U("initial"),H(),function(){if(!cur.audioCoverUploadOptions||!cur.audioCoverUploadOptions[t])return;var e=cur.audioCoverUploadOptions[t],i={file_name:"photo",file_size_limit:5242880,file_types_description:"Image files (*.jpg, *.jpeg, *.png, *.gif)",file_types:"*.jpg;*.JPG;*.jpeg;*.JPEG;*.png;*.PNG;*.gif;*.GIF;*.bmp;*.BMP",onUploadStart:function(e,t){show(geByClass1("_ape_cover_progress"))},onUploadComplete:function(e,t){(t=JSON.parse(t)).error?(show(C.errorMsg),x()):(hide(C.errorMsg),j((p=t).url),x()),hide(geByClass1("_ape_cover_progress"))},onUploadProgress:function(e,t,i){},onUploadError:function(e,t){hide(geByClass1("_ape_cover_progress"))},clear:1,type:"photo",max_attempts:3,server:e.server,noCheck:!0,chooseBox:!0,uploadButton:!0,accept:".jpg,.jpeg,.png",filesize_hide_last:!0,label:e.button};Upload.init(C.uploadCoverButton,e.url,e.vars,i),addEvent(geByClass1("_ape_cover_delete"),"click",Y),addEvent(C.uploadCoverButton,"click",function(){isObject(p)&&!isVisible(geByClass1("_ape_cover_progress"))||geByTag1("input",this).click()}),C.coverThumb=geByClass1("_ape_cover_thumb")}(),w.getCoverUrl()&&j(w.getCoverUrl()),autosizeSetup(C.playlistDescriptionInput,{minHeight:30,maxHeight:150,onResize:x}),C.playlistNameInput.value=replaceEntities(w.getTitle()),C.playlistDescriptionInput.value=replaceEntities(w.getRawDescription().replace(/<br>/g,"\n")));"attach"==e&&U("default");k(),v&&"attach"!=e&&m.setControlsText('<a onclick="AudioPage.deletePlaylist('+v.getOwnerId()+", "+v.getPlaylistId()+", '"+v.getEditHash()+"')\">"+getLang("audio_delete_playlist")+"</a>")}(m.bodyNode);var B=0;function T(){m.setOptions({title:'<div class="back _back">'+getLang("global_back")+"</div>",bodyStyle:"padding: 0"})}function k(){var e="";cur.audioAttachSwitchOwnerId&&cur.audioAttachOriginalOwnerId&&(e='<span class="dvd"></span><a class="tab_link" onclick="cur.audioAttachSwitch()">',e+=getLang(w.getOwnerId()<0?"audio_choose_wall_to_my_audios":"audio_choose_wall_to_group_audios"),w.getOwnerId()===cur.audioAttachOriginalOwnerId?cur.audioAttachSwitch=function(){AudioPage.showAttachBox(cur.audioAttachSwitchOwnerId,a)}:cur.audioAttachSwitch=function(){AudioPage.showAttachBox(cur.audioAttachOriginalOwnerId,a)},e+="</a>"),m.setOptions({title:f+e,bodyStyle:"padding: 0"})}function x(){setStyle(C.list,{height:getSize(C.boxContent)[1]-(getXY(C.list)[1]-getXY(C.boxContent)[1])})}function D(e,t,i){c=e,t?i?e.search({q:i},function(e){O(!0,e)}):O(!0,e.getUnshuffledAudiosList()):O(!1,i?A.search(i):o),R("initial"==_&&!i)}function O(e,t){C.list.innerHTML="",d&&d.destroy(),show(C.list),hide(C.emptyPlaceholder),hide(C.emptyGlobalPlaceholder),hide(C.emptyPlaylistsPlaceholder),x();var i=0;d=new AutoList(C.list,{scrollNode:C.list,onNoMore:function(){0===i&&(E()?e||(hide(C.list),show(C.emptyPlaylistsPlaceholder)):(hide(C.list),show(C.emptyPlaceholder))),e&&(clearTimeout(B),E()&&(B=setTimeout(function(){B=!1;var e=E();if(e){(h=n.getPlaylist(AudioPlaylist.TYPE_SEARCH,vk.id,hashCode(e+"no conflict"))).mergeWith({searchParams:{globalQuery:e},hasMore:!0}),u&&u.destroy();var t=0;d&&(t=d.getOffset(),d.destroy()),(d=new AutoList(C.list,{scrollNode:C.list,onNeedRows:function(e,i){i-=t,h.load(i,function(){var t=[],o=h.getAudiosList();if(0==i&&o.length&&t.push('<div class="ape_list_header">'+getLang("audio_edit_playlist_global_results")+"<div>"),o.length)for(var a=Math.min(o.length,i+20),s=i;s<a;s++)t.push(I(o[s]));h.getAudiosCount()||d&&d._offset?(hide(C.emptyGlobalPlaceholder),show(C.list)):(show(C.emptyGlobalPlaceholder),hide(C.list)),e(t)})}})).drawMore()}},300),y=null))},onNeedRows:function(o,a){for(var s=[],r=Math.min(t.length,a+20),l=a;l<r;l++){var n,d=t[l];if(e)n=I(d);else{var u='<div class="ape_pl_item_inner"><span class="ape_pl_title">'+(g?d.title.replace(g,"$1<em>$2</em>"):d.title)+'</span> <span class="ape_pl_size">'+langNumeric(d.size,cur.lang.audio_playlist_audios_count,!0).replace("{count}",d.size)+"</span></div>";n='<div class="ape_pl_item" data-playlist-access-hash="'+d.access_hash+'"  data-playlist-owner-id="'+d.owner_id+'" data-playlist-id="'+d.id+'">'+u+"</div>"}s.push(n)}i+=s.length,o(s)}})}function R(e){r||(r=new GridSorter(C.list,"ape_audio_item_wrap",{wrapNode:C.list,onReorder:function(e,t){var i,o=domData(geByClass1("_audio_row",e),"full-id"),a=w.indexOfAudio(o);t?(o=domData(geByClass1("_audio_row",t),"full-id"),i=w.indexOfAudio(o)):i=w.getAudiosCount(),w.moveAudio(a,i)}})),e?r.enable():r.disable()}function U(i,s){if("default"===i&&cur.audioPage&&cur.audioPage._data.addBanned)showFastBox({title:getLang("global_error")},cur.audioPage._data.addBannedText);else{switch(_=i,m.removeButtons(),domData(C.list,"view",i),i){case"initial":show(C.header),hide(C.addAudiosFromPlaylistsButton),show(C.addAudiosButton),show(C.search),hide(C.globalResults),D(w,!0),N(),k();break;case"default":var r=n.getPlaylist(AudioPlaylist.TYPE_PLAYLIST,t,AudioPlaylist.DEFAULT_PLAYLIST_ID);disableEl(C.addAudiosButton),showProgress(C.addAudiosButton),r.load(function(){enableEl(C.addAudiosButton),hideProgress(C.addAudiosButton),hide(C.header),show(C.search),toggle(C.addAudiosFromPlaylistsButton,P),hide(C.addAudiosButton),"edit"==e?T():k(),D(r,!0),x(),"edit"==e&&N()});break;case"playlists":hide(C.header),show(C.search),hide(C.addAudiosFromPlaylistsButton),hide(C.addAudiosButton),hide(C.globalResults),T(),D(o);break;case"playlist":hide(C.header),show(C.search),hide(C.addAudiosFromPlaylistsButton),hide(C.addAudiosButton),T(),D(s,!0),"attach"==e&&function(e){if(!a.canPlaylistAttach)return;m.addButton(a.playlistPickerButtonText,function(t){cur.onChoosePlaylist(t,e)},"ok",!0)}(s),"edit"==e&&N()}x(),C.searchInput.value="",elfocus(C.searchInput),g=!1,y=null,clearTimeout(B),n&&n.updateCurrentPlaying&&n.updateCurrentPlaying()}}function N(){m.addButton(getLang("audio_save_playlist_button"),F,"ok",!0)}function M(t){var i;if(i=domClosest("ape_pl_item",t.target)){var o=domData(i,"playlist-id"),a=domData(i,"playlist-owner-id"),s=domData(i,"playlist-access-hash"),r=n.getPlaylist(AudioPlaylist.TYPE_PLAYLIST,a,o,s);showProgress(i),r.load(function(){hideProgress(i),U("playlist",r)})}if(hasClass(t.target,"ape_check")){var l=function(e,t){if(cur.audioPage&&cur.audioPage._data.addBanned)showFastBox({title:getLang("global_error")},cur.audioPage._data.addBannedText);else{var i=toggleClass(e,"ape_selected",t),o=geByClass1("_audio_row",e),a=AudioUtils.getAudioFromEl(o);i?w.addAudio(a,0):w.removeAudio(a)}},d=domClosest("_ape_audio_item",t.target);if(t.shiftKey&&y){var u=domChildIndex(y),_=domChildIndex(d),c=domPN(d);if(u>_){var h=_;_=u,u=h}for(var g=hasClass(y,"ape_selected"),p=u;p<=_;p++)l(c.children[p],g)}else l(d),y=d;H()}if("attach"===e&&hasClass(t.target,"artist_link")){if(t.metaKey&&browser.mac||t.ctrlKey)return;var f=domData(t.target,"performer")||trim(t.target.innerText);f&&(val(C.searchInput,f),uiSearch.onChanged(C.searchInput),b(f))}return cancelEvent(t)}function H(){var e,t=w.getAudiosCount(),i=w.getTotalDuration();if(t){e=(e=langNumeric(t,cur.lang.audio_edit_playlist_audios_info)).replace("{count}",t);var o="",a=i%60,s=Math.floor(i/60)%60,r=Math.floor(i/3600);i<60?o=langNumeric(i,cur.lang.audio_total_dur_seconds):i<3600?(o=langNumeric(s,cur.lang.audio_total_dur_minutes),a&&(o+=" "+langNumeric(a,cur.lang.audio_total_dur_seconds))):(o=langNumeric(r,cur.lang.audio_total_dur_hours),s&&(o+=" "+langNumeric(s,cur.lang.audio_total_dur_minutes))),e+='<span class="dvd">'+o+"</span>"}else e=getLang("audio_edit_playlist_no_audios");C.stat.innerHTML=e}function F(e){var i=trim(val(C.playlistNameInput)),o=trim(val(C.playlistDescriptionInput));if(!i)return U("initial"),void notaBene(ge("ape_pl_name"));var s=[];each(w.getUnshuffledAudiosList(),function(e,t){s.push(t[AudioUtils.AUDIO_ITEM_INDEX_OWNER_ID]+"_"+t[AudioUtils.AUDIO_ITEM_INDEX_ID])});var r=a.newPlaylistHash||cur.audioPage&&cur.audioPage._data.newPlaylistHash||"";ajax.post("al_audio.php",{act:"save_playlist",hash:l?r:v.getEditHash(),owner_id:t,playlist_id:l?0:v.getPlaylistId(),title:i,description:o,Audios:s.join(","),cover:isObject(p)?JSON.stringify(p):p},{showProgress:lockButton.bind(this,e),onDone:function(e,i){each(geByClass("_audio_pl_"+e.ownerId+"_"+e.id),function(){var t=geByClass1("audio_pl__cover",this);if(t){setStyle(t,"background-image",e.coverUrl?"url("+e.coverUrl+")":null),setStyle(t,"background-size",e.coverUrl?"cover":null);var i=geByClass1("_audio_pl_grid_covers_wrap",this);i&&(i.innerHTML=e.coverUrl?"":e.gridCovers)}var o=geByClass1("audio_pl__title",this);if(o){var a=geByClass1("audio_item__title",o);a?val(a,e.title):val(o,e.title)}var s=geByClass1("_audio_pl__stats_count",this);s&&(s.innerHTML=e.totalCount)}),l&&cur.audioPage&&t==cur.audioPage.getOwnerId()&&(each(geByClass("_audio_page_block__playlists_items",cur.audioPage._els.pageContainer),function(){var e=se(getTemplate("audio_pl_item",i));this.insertBefore(e,this.firstChild);var t=intval(domData(this,"max-items"));t&&this.children.length>t&&this.removeChild(this.lastChild),show(gpeByClass("_audio_page__playlists",this))}),cur.audioPage._data.playlists=cur.audioPage._data.playlists||[],cur.audioPage._data.playlists.unshift(i)),cur.audioPage&&cur.audioPage.updatePlaylistsCounter&&cur.audioPage.updatePlaylistsCounter(t),v&&(v.clean(),v.mergeWith(e)),m.hide(!0)},onFail:function(){m.hide(!0)}})}function j(e){show(C.coverThumb),setStyle(C.coverThumb,"background-image","url("+e+")"),addClass(C.uploadCoverButton,"ape_thumb_set")}function Y(e){return removeClass(C.uploadCoverButton,"ape_thumb_set"),hide(geByClass1("_ape_cover_thumb")),p=-1,cancelEvent(e)}},AudioPage._buildAudiosAndPlaylistsList=function(){},AudioPage.prototype.updateSearchUrl=function(){var e=this.getCurrentPlaylist();if(e.getType()==AudioPlaylist.TYPE_SEARCH&&!this.isLayer()){var t=e.getSearchParams();nav.setLoc(extend(nav.objLoc,{q:t.q}))}},AudioPage.prototype._deinitKeyEvents=function(){this._audioHQKeyEventHandler1&&removeEvent(window.document,"keydown",this._audioHQKeyEventHandler1),this._audioHQKeyEventHandler2&&removeEvent(window.document,"keyup",this._audioHQKeyEventHandler2),this._audioHQKeyEventHandler3&&removeEvent(window.document,"visibilitychange",this._audioHQKeyEventHandler3),this._audioHQKeyEventHandler4&&removeEvent(window.document,"mousedown",this._audioHQKeyEventHandler4),this._audioSeekKeyEventHandler&&removeEvent(window.document,"keydown",this._audioSeekKeyEventHandler)},AudioPage.prototype._initKeyEvents=function(){var e=this;this._deinitKeyEvents();var t=getAudioPlayer(),i=function(){return!e.isLayer()&&AudioUtils.getLayer().isShown()};addEvent(window.document,"mousedown",this._audioHQKeyEventHandler4=function(e){e.ctrlKey&&(cur.ctrlMouseDown=!0,cur.ctrlPressed=!1)},!0),addEvent(window.document,"keydown",this._audioHQKeyEventHandler1=function(e){i()||(cur.ctrlPressed=e.keyCode===KEY.CTRL)}),addEvent(window.document,"keyup",this._audioHQKeyEventHandler2=function(e){i()||(e.keyCode!==KEY.CTRL||cur.ctrlMouseDown)&&(delete cur.ctrlMouseDown,delete cur.ctrlPressed)}),addEvent(window.document,"keydown",this._audioSeekKeyEventHandler=function(e){var o=e.target,a=o&&inArray(o.tagName.toLowerCase(),["input","textarea"])&&""!==val(o),s=o&&o.isContentEditable;a||s||!i()&&t.isPlaying()&&inArray(e.keyCode,[KEY.RIGHT,KEY.LEFT])&&!e.ctrlKey&&t.seekCurrentAudio(e.keyCode===KEY.RIGHT)}),cur.destroy.push(function(){return e._deinitKeyEvents()})},AudioPage.prototype.editFeed=function(){var e=this;showTabbedBox("al_settings.php",{act:"a_edit_owners_list",list:"audio",height:lastWindowHeight},{stat:["privacy.js","privacy.css","ui_controls.js","ui_controls.css","indexer.js"],dark:1}),cur.onOListSave=function(t,i,o,a){var s=curBox(),r={act:"a_ignore_olist",hash:a.hash};return t.length<i.length?r.White=t.join(","):r.Black=i.join(","),ajax.post("al_audio.php",r,{onDone:function(t,i){s.hide(),e.getCurrentPlaylist().clean(),e.refreshCurrentPage()},showProgress:s.showProgress,hiderogress:s.hideProgress}),!1}},AudioPage.prototype.updateStatusExportControls=function(e){var t=getAudioPlayer(),i=t.getStatusExportInfo();each(geByClass("_audio_export_status",this._els.pageContainer),function(){toggleClass(this,"on",!!i[domData(this,"oid")])});var o=t.hasStatusExport(),a=geByClass1("_audio_page_player_status",this._els.pageContainer);if(toggleClass(a,"audio_page_player_btn_enabled",o),!e)if(this.isLayer())cur.audioPage&&cur.audioPage.updateStatusExportControls(!0);else{var s=AudioUtils.getLayer().getPageInstance();s&&s.updateStatusExportControls(!0)}return!1},AudioPage.prototype.updateStatusExport=function(e,t){e&&checkbox(e),t=intval(t);var i,o,a=getAudioPlayer(),s=a.getStatusExportInfo()||{};if(t)s[t]?(delete s[t],i=!1):(s[t]=1,i=!0);else if(a.hasStatusExport()){for(var r in s)delete s[r];i=!1}else s[t=vk.id]=1,i=!0;a.setStatusExportInfo(s),t!=vk.id&&t||checkbox("currinfo_audio",a.hasStatusExport()),this.updateStatusExportControls();var l=a.getCurrentAudio();l&&(o=AudioUtils.asObject(l).fullId);a.getCurrentPlaylist();ajax.post("al_audio.php",{act:"toggle_status",exp:intval(i),oid:t,hash:vk.statusExportHash,id:o,top:intval(null)})},AudioPage.prototype.playStatusAudio=function(e,t,i){var o=gpeByClass("_audio_friend",i);getAudioPlayer().playLive(e,{showProgress:showProgress.pbind(o),hideProgress:hideProgress.pbind(o)}),cancelEvent(t)},AudioPage.showActionTooltip=function(e,t){var i=[3,-8,0],o=currentAudioPage(e).isLayer();hasClass(e,"_audio_page_player_add")?audioShowActionTooltip(e,i,o):(hasClass(e,"_audio_page_player_play_rate")&&(i[0]=-17),showTooltip(e,{text:t,black:1,shift:i,appendParentCls:"_audio_page_player",forcetodown:o,needLeft:o}))},AudioPage.prototype.onHide=function(){var e=this;cur.nav=cur.nav.filter(function(t){return e._nav_func!=t}),this._deinitKeyEvents()},AudioPage.prototype.showRecoms=function(e,t,i){if(!t){var o=this._readyAudio?this._readyAudio:getAudioPlayer().getCurrentAudio();t=AudioUtils.asObject(o).fullId}nav.go({0:"audios"+this.getOwnerId(),section:"recoms_audio",audio_id:t},null,{nocur:!0})},AudioPage.prototype.onAudioUploaded=function(e,t){if(t){var i=getAudioPlayer(),o=i.getPlaylist(AudioPlaylist.TYPE_PLAYLIST,this.getOwnerId(),AudioPlaylist.DEFAULT_PLAYLIST_ID);o.addAudio(t,0);var a=i.getCurrentPlaylist();a&&a.getSelf()==o&&a.addAudio(t),"all"==this._currentSection&&this._initAudioRowsAutoList();var s=AudioUtils.asObject(t),r=5,l=this;!function e(i){--r<0||setTimeout(function(){ajax.post("al_audio.php",{act:"check_audio_data",audio_owner_id:s.ownerId,audio_id:s.id},{onDone:function(o){if(o){var a=o[AudioUtils.AUDIO_ITEM_INDEX_TITLE]!=t[AudioUtils.AUDIO_ITEM_INDEX_TITLE];(a=(a=a||o[AudioUtils.AUDIO_ITEM_INDEX_PERFORMER]!=t[AudioUtils.AUDIO_ITEM_INDEX_PERFORMER])||o[AudioUtils.AUDIO_ITEM_INDEX_FLAGS]!=t[AudioUtils.AUDIO_ITEM_INDEX_FLAGS])&&(getAudioPlayer().updateAudio(s.fullId,o),"all"==l._currentSection&&"audio"==cur.module&&l._initAudioRowsAutoList(),s=o),e(1.5*i)}}})},i)}(1e3)}},AudioPage.prototype.uploadAudio=function(e){this._data.uploadBanned?showFastBox({title:getLang("global_error")},this._data.uploadBannedText):showBox("al_audio.php",extend(e||{},{act:"new_audio",gid:this.getOwnerId()<0?-this.getOwnerId():0}),{params:{width:"450px",bodyStyle:"padding: 0px; position: relative;"},dark:1})},AudioPage.prototype.editAudio=function(e,t,i){return showBox("al_audio.php",{act:"edit_audio_box",aid:t},{params:{width:"456px",bodyStyle:"padding: 20px; background-color: #F7F7F7;",hideButtons:1},dark:1}),i&&cancelEvent(i),!1},AudioPage.prototype.restoreRecommendation=function(e){var t=AudioUtils.getAudioFromEl(e,!0),i={act:"restore_recommendation",hash:AudioUtils.getAudioExtra(t).recom.hash,audio_id:t.fullId};nav.objLoc.audio_id&&(i.recommendation_type="query"),nav.objLoc.album_id&&(i.recommendation_type="album"),ajax.post("al_audio.php",i),removeClass(e,"audio_row__deleted");var o=AudioUtils.getAddRestoreInfo(),a=o[t.fullId].removedCurrentPos,s=getAudioPlayer().getCurrentPlaylist();a>=0&&s&&s.getType()==AudioPlaylist.TYPE_RECOM&&s.addAudio(AudioUtils.getAudioFromEl(e),a),delete o[t.fullId],AudioUtils.onRowOver(e,!1,!0)},AudioPage.isInRecentPlayed=function(e){var t=gpeByClass("_audio_playlist",e);return!(!t||!hasClass(t,"audio_recent_rows"))&&data(t,"playlist")},AudioPage.prototype.chooseFromMyAudios=function(e){var t=this;AudioPage.editPlaylist(vk.id,AudioPlaylist.DEFAULT_PLAYLIST_ID,"attach",{audioPickerButtonText:getLang("global_add"),playlistPickerButtonText:getLang("global_add"),onAudioChoose:function(i,o,a){var s=i.ctrlKey;if(ajax.post("al_audio.php",{act:"add",group_id:e,audio_owner_id:a.ownerId,audio_id:a.id,hash:a.addHash},{onDone:function(i){var o=e?-e:vk.id;i&&(getAudioPlayer().getPlaylist(AudioPlaylist.TYPE_PLAYLIST,o,AudioPlaylist.DEFAULT_PLAYLIST_ID).addAudio(i,0),t._initAudioRowsAutoList())}}),s)o.innerHTML=getLang("audio_choose_added"),addClass(o,"ape_added");else if(__bq)for(;__bq.count();)__bq.hideLast()}})},AudioPage.prototype.toggleAudioDurationType=function(){this.ap.toggleDurationType()},AudioPage.prototype.updateShuffleButton=function(){var e=getAudioPlayer().getCurrentPlaylist()||this._pagePlaylist;if(e){var t=e.isShuffled()&&!e.isInitedSortedList();toggleClass(geByClass1("_audio_page_player_shuffle",this._els.pageContainer),"audio_page_player_btn_enabled",t),this.isLayer()&&cur.audioPage&&cur.audioPage.updateShuffleButton()}},AudioPage.prototype.togglePodcast=function(e,t){if(toggleClass(this._els.player,"audio_player_podcast",e),this._updatePlaybackRate(),!this.isPodcastPage()){toggle(geByClass1("_audio_section_tab__current",this._els.pageContainer),!e);var i=geByClass1("_audio_section_tab__podcast",this._els.pageContainer);toggle(i,e),i&&e&&(t=t||getAudioPlayer().getCurrentAudio(),attr(geByClass1("ui_tab",i),"href","podcasts"+t[AudioUtils.AUDIO_ITEM_INDEX_OWNER_ID]))}},AudioPage.prototype.updateFaveButton=function(){var e=getAudioPlayer().getCurrentFaveStatus(),t=geByClass1("audio_page_player_fave",this._els.player);t&&toggleClass(t,"activated",e)},AudioPage.prototype.toggleRepeat=function(){if(!this.isPodcastPage()){var e=getAudioPlayer();e.isRepeatAll()||e.isRepeatCurrentAudio()?e.toggleRepeatCurrentAudio():e.toggleRepeatAll(),this.updateRepeatButton()}},AudioPage.prototype.updateRepeatButton=function(){var e=geByClass("_audio_page_player_repeat");if(e&&e.length){var t=getAudioPlayer(),i=t.isRepeatAll(),o=t.isRepeatCurrentAudio();each(e,function(e,t){toggleClass(t,"audio_page_player_btn_enabled",i),toggleClass(t,"audio_page_player_btn_repeat_one",o)})}},AudioPage.prototype.toggleShuffle=function(e){if(!this.isPodcastPage()){toggleClass(e,"audio_page_player_btn_enabled")&&statlogsValueEvent("audio_sort_stat","audio_sort","shuffle_player",this.isLayer()?"layer":"page");var t=getAudioPlayer().getCurrentPlaylist()||this._pagePlaylist;t.loadAll(function(){t.isShuffled()&&t.isInitedSortedList()?(t.shuffle(0),t.shuffle(irand(1,999999))):t.isShuffled()?t.shuffle(0):t.shuffle(irand(1,999999)),"current"==this._currentSection&&this._initAudioRowsAutoList(!0);var e=getAudioPlayer().getCurrentAudio()||t.getAudioAt(0);getAudioPlayer().play(e,t),this.updateShuffleButton()}.bind(this))}},AudioPage.prototype.toggleFave=function(e){var t=getAudioPlayer(),i=t.getCurrentAudio()||this._readyAudio;AudioUtils.isPodcast(i)&&t.podcastToggleFave(e,i)},AudioPage.prototype.changePlaybackRate=function(e,t){var i=getAudioPlayer().getCurrentAudio()||this._readyAudio;AudioUtils.isPodcast(i)&&(getAudioPlayer().podcastChangePlaybackRate(!!t.shiftKey),this._updatePlaybackRate())},AudioPage.prototype._updatePlaybackRate=function(){var e=geByClass1("audio_page_player_play_rate",this._els.player);e&&val(geByClass1("btn_icon",e),getAudioPlayer().podcastGetPlaybackRate()+"x")},AudioPage.prototype._getCurrentSearchParams=function(){var e=window.radioBtns["audio_search_type_"+intval(this.isLayer())],t=intval(this._searchSortFilter.selectedItems()[0][0]);return{performer:e&&e.val?1:null,lyrics:hasClass(geByClass1("_audio_fltr_with_lyrics",this._container),"on")?1:null,sort:t?1:null}},AudioPage.searchAudios=function(e,t,i){currentAudioPage(this).searchAudios(e,t,i)},AudioPage.prototype.searchAudios=function(e,t,i){this.lastQuery!==e&&(this.lastQuery=e,this._muteSearch?delete this._muteSearch:(e=trim(e),nav.change(extend(this._getCurrentSearchParams(),{q:e||null}),!1,{fromSearch:!0,globalQuery:e,fromHistory:i,isLayer:this.isLayer()})))},AudioPage.prototype.onUserAction=function(e,t){var i=t.indexOfAudio(e);if(-1!=i&&t.getType()==AudioPlaylist.TYPE_SEARCH&&(!(t.getOwnerId()==vk.id&&i>=0&&i<t.getLocalFoundCount())&&t.getSearchParams())){var o=t.getSearchParams();o.globalQuery&&uiSearch.saveHistorySearch(this.searchInputEl,o.globalQuery,e.ownerId,e.id,t.getTotalCount(),t.getTotalCountHash())}},AudioPage.prototype._updateFriendsList=function(e,t,i){if(e=trim(e),this._friendSearchInProgress=!1,e){var o=geByClass1("_audio_friends_list",this._els.pageContainer),a=se('<div class="audio_friends_list _audio_friends_list" style="">'+e+"</div>");i&&(this._shownFriends=[]),domPN(o).appendChild(a),re(o)}},AudioPage.searchMoreFriends=function(e){this._searchMoreFriends(e)},AudioPage.prototype._searchMoreFriends=function(e){this._friendSearchInProgress||(this._friendSearchInProgress=!0,ajax.post("al_audio.php",{act:"search_friends",str:e},{onDone:this._updateFriendsList.bind(this)}))},AudioPage.prototype.showMoreFriends=function(e,t){this._friendSearchInProgress||(this._friendSearchInProgress=!0,this._shownFriends=this._shownFriends||[],each(geByClass("_audio_friend",this._els.pageContainer),function(e,t){this._shownFriends.push(domData(t,"id"))}.bind(this)),ajax.post("al_audio.php",{act:"more_friends",exclude:!t&&this._shownFriends.join(","),owner:t},{showProgress:!!e&&lockButton.pbind(e),hideProgress:!!e&&unlockButton.pbind(e),onDone:this._updateFriendsList.bind(this)}))},AudioPage.prototype.shareAudio=function(){var e=e||getAudioPlayer().getCurrentAudio()||this._readyAudio;AudioUtils.shareAudio(!1,e)},AudioPage.prototype.showStatusTooltip=function(e){this.statusTT||(this.statusTT=!0,ajax.post("al_audio.php",{act:"status_tt"},{onDone:function(t,i){this.statusTT=new ElementTooltip(e,{content:i,width:250,offset:[1,14],elClassWhenShown:"audio_status_tt_shown",id:"audio_status_tt",onFirstTimeShow:function(e){this.sb=new uiScroll(geByClass1("audio_status_wrap",e),{global:!0})},onShow:function(){setTimeout(function(){this.statusTT.sb.update()}.bind(this),0)}.bind(this)}),cur._onStatusExportBtn&&(this.statusTT.show(),this.statusTT.sb.update())}.bind(this)}))},AudioPage.prototype.isLayer=function(){return this._data.isLayer},AudioPage.prototype.isPodcastPage=function(){return!this.isLayer()&&!!this._data.podcastPage},AudioPage.prototype.destroy=function(){this._trackSlider&&this._trackSlider.destroy(),this._volumeSlider&&this._volumeSlider.destroy(),removeEvent(window,"scroll",this._ev_onScroll)},AudioPage.prototype.getPageCurrentPlaylist=function(){return this._pagePlaylist},AudioPage.prototype.clearCurrentPlaylist=function(){if(this.isLayer()){var e=getAudioPlayer();e.deleteCurrentPlaylist();var t=geByClass1("_audio_section_tab__current",this._els.pageContainer);addClass(t,"unshown"),uiTabs.switchTab(domFC(geByClass1("_audio_section_tab__all",this._els.pageContainer)),{noAnim:!0}),this.updateCurrentPlayingInfo(),this.togglePodcast(!1),this.showSection("all"),this.updateLayerHeight();var i=e.getPlaylist(AudioPlaylist.TYPE_PLAYLIST,vk.id,AudioPlaylist.DEFAULT_PLAYLIST_ID).getAudiosList()[0];i&&(this._readyAudio=i,this._initPlayer(!0),this.isLayer()&&cur.audioPage&&(cur.audioPage._readyAudio=i,cur.audioPage._initPlayer(!0)))}},AudioPage.prototype.setTooltipTitle=function(e){if(!e.titleSet){var t=geByClass1("audio_page_player_title_performer",e),i=geByClass1("audio_page_player_title_song",e);(t.scrollWidth>t.clientWidth||i.scrollWidth>i.clientWidth)&&e.setAttribute("title",e.innerText),e.titleSet=!0}},AudioPage.prototype._initPlayer=function(e){var t=this,i=this,o=getAudioPlayer(),a=this._els.pageContainer,s=geByClass1("_audio_page_player",a),r=geByClass1("audio_page_player_title",s),l=geByClass1("audio_page_player_title_performer",s),n=geByClass1("audio_page_player_title_song",s),d=geByClass1("audio_page_player_title_song_title",s),u=geByClass1("audio_page_player_title_song_subtitle",s),_=geByClass1("audio_page_player_duration",s),c=geByClass1("_audio_page_player__cover",s),h=geByClass1("_audio_page_player_play",s),g=geByClass1("_play_blind_label",h),p=(geByClass1("_audio_page_player_repeat",s),geByClass1("_audio_page_player_add",s)),y=void 0;function f(e){if(o.isAdPlaying())l.innerHTML=getLang("global_audio_ad"),setStyle(n,"display","none"),toggleClass(s,"audio_song_is_explicit",!1);else{var t=AudioUtils.getAudioPerformers(e);e=AudioUtils.asObject(e),setStyle(n,"display","block"),l.innerHTML=geByClass1("audio_page_player2")?t:e.performer,AudioUtils.isPodcast(e)?d.innerHTML='<a href="/podcast'+e.fullId+'" onclick="return showPodcast(this, \''+e.fullId+"', event, 'player');\" class=\"audio_player_podcast_title\">"+e.title+"</a>":d.innerHTML=e.title,u.innerHTML=e.subTitle?e.subTitle:"",e.coverUrl_p?(setStyle(c,"background-image","url("+e.coverUrl_p+")"),setStyle(c,"background-size","cover")):(setStyle(c,"background-image",null),setStyle(c,"background-size","")),toggleClass(s,"audio_title_long_performer",e.isLongPerformer),toggleClass(s,"audio_song_is_explicit",e.isExplicit),!i.isLayer()&&o.getCurrentAudio()&&AudioUtils.asObject(o.getCurrentAudio()).fullId==e.fullId&&(setDocumentTitle(replaceEntities(stripHTML(e.performer+" - "+e.title))),clearTimeout(window.pageSetTitleTimer))}}function A(e,t){return t=intval(t),o.getDurationType()&&1!=e?"-"+formatTime(Math.round(t-e*t)):formatTime(Math.round(e*t))}function P(){if(i._trackSlider){var e=AudioUtils.asObject(o.getCurrentAudio()||i._readyAudio);if(e){var t=!1;t=i.getOwnerId()<0&&i.canAddToGroup()?e.ownerId!=i.getOwnerId():e.ownerId!=vk.id,y!==t&&(toggle(p,t),y=t),cur._audioAddRestoreInfo=cur._audioAddRestoreInfo||{};var a=cur._audioAddRestoreInfo[e.fullId];addClass(p,"no_transition"),toggleClass(p,"audio_player_btn_added",!(!a||"added"!=a.state)),removeClassDelayed(p,"no_transition"),i.updateRepeatButton()}}}if(!this._trackSlider){var v=o.isAdPlaying()?o.adsGetCurrentProgress():o.getCurrentProgress(),w=o.isAdPlaying()?0:o.getCurrentBuffered(),m=geByClass1("audio_page_player_track_slider",s),C=geByClass1("audio_page_player_volume_slider",s);m&&(this._trackSlider=new Slider(m,{value:v,backValue:w,size:1,hintClass:"audio_player_hint",withBackLine:!0,formatHint:function(e){var i=o.getCurrentAudio()||t._readyAudio;return i=AudioUtils.asObject(i),formatTime(Math.round(e*(i?i.duration:0)))},onEndDragging:function(e){var i=o.getCurrentAudio()||t._readyAudio;(i=AudioUtils.asObject(i))&&AudioUtils.isPodcast(i)&&o.podcastSetActionRef(i,AudioUtils.PodcastsLogs.ACTION_SEEK,"",s),o.seek(e)}}),o.isAdPlaying()&&(this._trackSlider.toggleAdState(!0),this.toggleRemoveAdsLink(!0))),C&&(this._volumeSlider=new Slider(C,{value:o.getVolume(),size:1,hintClass:"audio_player_hint",log:!0,formatHint:function(e){return Math.round(100*e)+"%"},onChange:function(e){o.setVolume(e)}})),o.on(this,AudioPlayer.EVENT_AD_DEINITED,function(){}),o.on(this,AudioPlayer.EVENT_AD_READY,function(){}),o.on(this,AudioPlayer.EVENT_AD_STARTED,function(){t.toggleRemoveAdsLink(!0),t._trackSlider&&(t._trackSlider.toggleAdState(!0),t._trackSlider.setBackValue(0))}),o.on(this,AudioPlayer.EVENT_AD_COMPLETED,function(){t.toggleRemoveAdsLink(!1),t._trackSlider&&t._trackSlider.toggleAdState(!1)}),o.on(this,AudioPlayer.EVENT_START_LOADING,function(){t._trackSlider&&t._trackSlider.toggleLoading(!0)}),o.on(this,AudioPlayer.EVENT_CAN_PLAY,function(){t._trackSlider&&t._trackSlider.toggleLoading(!1)}),o.on(this,AudioPlayer.EVENT_ADDED,function(e,t){(e=AudioUtils.asObject(e))&&e.fullId==t&&addClass(p,"audio_player_btn_added")}),o.on(this,AudioPlayer.EVENT_REMOVED,function(e,t){(e=AudioUtils.asObject(e))&&e.fullId==t&&removeClass(p,"audio_player_btn_added")}),o.on(this,AudioPlayer.EVENT_PLAY,function(e,i,a){delete t._readyAudio,data(s,"audio",e),P(),f(e),addClass(h,"audio_playing"),i&&!cur.audioStartReadyAudio&&(t._trackSlider&&t._trackSlider.setBackValue(0),o.isAdPlaying()||(_.innerHTML=A(0,AudioUtils.asObject(e).duration)),r.setAttribute("title",""),r.titleSet=!1),g.innerHTML=getLang("global_audio_pause"),t.updateCurrentPlayingInfo(),t.updateShuffleButton(),t.updateFaveButton()}),o.on(this,AudioPlayer.EVENT_PAUSE,function(){removeClass(h,"audio_playing"),g.innerHTML=getLang("global_audio_play")}),o.on(this,AudioPlayer.EVENT_STOP,function(){removeClass(h,"audio_playing"),g.innerHTML=getLang("global_audio_play")}),o.on(this,AudioPlayer.EVENT_BUFFERED,function(e,i){t._trackSlider&&t._trackSlider.setBackValue(i)}),o.on(this,AudioPlayer.EVENT_VOLUME,function(e,i){t._volumeSlider&&t._volumeSlider.setValue(i)}),o.on(this,AudioPlayer.EVENT_ENDED,function(){t._trackSlider&&t._trackSlider.toggleLoading(!1)}),o.on(this,AudioPlayer.EVENT_UPDATE,function(e,t){e&&f(e),o.isAdPlaying()||e&&t&&(_.innerHTML=A(t,AudioUtils.asObject(e).duration))}),o.on(this,AudioPlayer.EVENT_PROGRESS,function(e,i,o){t._trackSlider&&(t._trackSlider.toggleLoading(!1),t._trackSlider.setValue(i)),isUndefined(o)||isNaN(o)||(_.innerHTML=A(i,o))}),o.on(this,AudioPlayer.EVENT_FAILED,function(){t._trackSlider&&t._trackSlider.toggleLoading(!1)}),o.on(this,AudioPlayer.EVENT_CURRENT_CHANGED,function(){var e=o.getCurrentAudio()||t._readyAudio;domData(t._els.player,"audio",JSON.stringify(e)),t.togglePodcast(AudioUtils.isPodcast(e),e)})}var b=o.getCurrentAudio()||this._readyAudio;b&&(domData(s,"audio",JSON.stringify(b)),f(b),toggleClass(h,"audio_playing",o.isPlaying()),_.innerHTML=A(1,AudioUtils.asObject(b).duration),e&&this._trackSlider&&(this._trackSlider.setValue(0),this._trackSlider.setBackValue(0),this._trackSlider.toggleLoading(!1))),P();var S=o.getCurrentAudio()||this._readyAudio;this.togglePodcast(AudioUtils.isPodcast(S),S),this.isLayer()||this._initFixedPlayer()},AudioPage.prototype._initFixedPlayer=function(){var e=getSize(this._els.playerWrap);setStyle(this._els.playerWrap,{width:e[0],height:e[1]});var t,i=getSize(this._els.player);setStyle(this._els.player,{width:i[0],height:i[1]});var o=getSize("page_header_wrap")[1],a=getXY(this._els.contentBlock)[1],s=getXY(this._els.playerWrap)[1]+getSize(this._els.playerWrap)[1]-o,r=!1;addEvent(window,"scroll",this._onScroll=function(){var e=scrollGetY(),i=e>a;if(e<s&&(t||r))return clearTimeout(t),removeClass(this._els.player,"audio_page_player_fixed_shown"),removeClass(this._els.player,"audio_page_player_fixed"),void(r=t=!1);i&&!r&&(clearTimeout(t),t=0,addClass(this._els.player,"audio_page_player_fixed"),addClassDelayed(this._els.player,"audio_page_player_fixed_shown"),r=!0),!i&&r&&(clearTimeout(t),t=0,removeClass(this._els.player,"audio_page_player_fixed_shown"),t=setTimeout(function(){removeClass(this._els.player,"audio_page_player_fixed"),t=!1}.bind(this),250),r=!1)}.bind(this)),cur.destroy.push(function(){this._onScroll&&removeEvent(window,"scroll",this._onScroll)}.bind(this))},AudioPage.prototype.togglePlayerPlay=function(e){var t=getAudioPlayer();if(t.isPlaying()){(s=t.getCurrentAudio())&&t.podcastSetActionRef(s,AudioUtils.PodcastsLogs.ACTION_PAUSE,"",e),t.pause()}else{var i,o=this.getPageCurrentPlaylist(),a=t.getCurrentPlaylist(),s=t.getCurrentAudio(),r=this._readyAudio?this._readyAudio:s;if(r=r||o.getAudioAt(0),AudioUtils.isClaimedAudio(r)){r=AudioUtils.asObject(r);var l=AudioUtils.getAudioExtra(r).claim;return void showAudioClaimWarning(r,l)}o&&-1!=o.indexOfAudio(r)?i=o:a&&-1!=a.indexOfAudio(r)?i=a:(i=new AudioPlaylist(AudioPlaylist.TYPE_TEMP,vk.id)).addAudio(r),delete this._readyAudio,cur.audioStartReadyAudio=!0,t.podcastSetActionRef(r,AudioUtils.PodcastsLogs.ACTION_PLAY,"",e),t.play(r,i)}},AudioPage.prototype.promoAlbumSlideInit=function(){var e=this,t=geByClass1("audio_promo");if(!this.isLayer()&&t){var i=geByClass1("audio_promo__items",t);if(i&&!(i.children.length<=1)){this.promoAlbumSlideAutoStart(i);var o=function(){return e.promoAlbumSlideAutoStop()},a=function(){return e.promoAlbumSlideAutoStart(i)};addEvent(t,"mouseenter",o),addEvent(t,"mouseleave",a),window.cur&&cur.destroy.push(function(){e.promoAlbumSlideAutoStop(),removeEvent(t,"mouseenter",o),removeEvent(t,"mouseleave",a)})}}},AudioPage.prototype.promoAlbumSlideAutoStart=function(e){var t=this;window.cur&&(cur._promoAlbumSlideTO=setTimeout(function(){return t.promoAlbumSlide(e,1)},SLIDER_TIMEOUT))},AudioPage.prototype.promoAlbumSlideAutoStop=function(){window.cur&&clearTimeout(cur._promoAlbumSlideTO)},AudioPage.prototype.promoAlbumSlide=function(e,t){var i=vk.rtl?t>0?-1:1:t<0?-1:1,o=gpeByClass("audio_promo",e);if(o){var a=geByClass1("audio_promo__items",o);if(a&&!data(a,"sliding")){this.promoAlbumSlideAutoStop();var s=a.scrollLeft,r=a.offsetWidth,l=a.children,n=l.length,d=function(e){return vk.rtl?a.scrollWidth-e*r-r:e*r};if(l.length>1){this.promoAlbumSlideAutoStart(e);var u=!1,_=null,c=!1,h=Math.round(s/r);(h+=i)>=n||h<0?(u=l[0].cloneNode(!0),a.appendChild(u),h>=n?(c=!0,_=d(h),h=0):h<0&&(a.scrollLeft=d(n),_=d(h=n-1))):_=d(h),data(a,"sliding",!0),animate(a,{scrollLeft:_},{duration:500,transition:Fx.Transitions.swiftOut,onComplete:function(){c&&(a.scrollLeft=d(0)),u&&re(u),data(a,"sliding",!1)}})}}}},AudioPage.prototype.promoAlbumClose=function(e,t){var i=gpeByClass("audio_promo__block",e),o=gpeByClass("audio_promo__items",i),a=gpeByClass("audio_promo",i);re(i);var s=o.children.length;if(s<=1){var r=geByClass1("audio_promo__left",a),l=geByClass1("audio_promo__right",a);addClass(r,"hidden"),addClass(l,"hidden")}s||addClass(a,"hidden"),ajax.post("al_audio.php",{act:"hide_promo",promo_name:t})},AudioPage.prototype.toggleRemoveAdsLink=function(e){toggleClass(this._els.player,"audio_page_player_show_remove_ads",!!e)},AudioPage.prototype.showPromoBox=function(){this.isPodcastPage()||ajax.post("al_audio.php?act=need_show_promo",{},{onDone:function(e){e&&showWiki({w:"promo_box"})}})},window.AudioPage||(window.AudioPage=AudioPage,window.currentAudioPage=currentAudioPage);try{stManager.done("audio.js")}catch(e){}}});